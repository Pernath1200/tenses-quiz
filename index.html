<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>English Grammar Check</title>
  <style>
    :root {
      --bg: #1a1b26;
      --surface: #24283b;
      --text: #c0caf5;
      --muted: #565f89;
      --correct: #9ece6a;
      --wrong: #f7768e;
      --accent: #7aa2f7;
      --radius: 8px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1rem;
      min-height: 100vh;
    }
    .container { max-width: 640px; margin: 0 auto; }
    h1 { font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--accent); }
    .sub { color: var(--muted); font-size: 0.9rem; margin-bottom: 1.5rem; }
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    label { display: block; margin-bottom: 0.25rem; color: var(--muted); font-size: 0.85rem; }
    select, input[type="number"], button {
      width: 100%;
      padding: 0.6rem;
      border-radius: var(--radius);
      border: 1px solid var(--muted);
      background: var(--bg);
      color: var(--text);
      font-size: 1rem;
    }
    button {
      cursor: pointer;
      background: var(--accent);
      border: none;
      color: var(--bg);
      font-weight: 600;
      margin-top: 0.5rem;
    }
    button:hover { filter: brightness(1.1); }
    button.secondary { background: var(--surface); color: var(--text); border: 1px solid var(--muted); }
    .scores { font-size: 0.9rem; color: var(--muted); margin-bottom: 1rem; }
    .question-block { margin-bottom: 1.5rem; }
    .question-text { white-space: pre-line; margin-bottom: 0.75rem; line-height: 1.5; }
    .options { display: flex; flex-direction: column; gap: 0.5rem; }
    .option {
      padding: 0.6rem;
      border-radius: var(--radius);
      border: 1px solid var(--muted);
      background: var(--bg);
      cursor: pointer;
    }
    .option:hover { border-color: var(--accent); }
    .option.selected { border-color: var(--accent); background: rgba(100, 149, 237, 0.2); }
    .option.correct { border-color: var(--correct); background: rgba(158, 206, 106, 0.15); }
    .option.wrong { border-color: var(--wrong); background: rgba(247, 118, 142, 0.15); }
    .explanation { margin-top: 0.75rem; padding: 0.75rem; background: var(--bg); border-radius: var(--radius); font-size: 0.9rem; color: var(--text); }
    .correct-answer-line { margin: 0.5rem 0 0; padding: 0.5rem; background: rgba(158, 206, 106, 0.12); border-radius: var(--radius); color: var(--text); font-size: 0.95rem; }
    .explanation-label { margin: 0.5rem 0 0; font-weight: 600; font-size: 0.9rem; color: var(--text); }
    .result-ok { color: var(--correct); }
    .result-fail { color: var(--wrong); }
    .progress { margin-bottom: 1rem; color: var(--muted); font-size: 0.9rem; }
    input[type="text"] { width: 100%; padding: 0.6rem; border-radius: var(--radius); border: 1px solid var(--muted); background: var(--bg); color: var(--text); }
    .summary { margin-top: 1.5rem; padding: 1rem; background: var(--surface); border-radius: var(--radius); font-size: 0.9rem; line-height: 1.6; }
    .hidden { display: none !important; }
    .actions { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem; }
    .actions button { flex: 1; min-width: 140px; }
    .progress-card { margin-top: 1rem; }
    .progress-card h3 { font-size: 1rem; color: var(--accent); margin-bottom: 0.5rem; }
    .progress-stats { display: grid; gap: 0.5rem; font-size: 0.9rem; color: var(--muted); }
    .progress-stats span { color: var(--text); }
    .history-line { font-size: 0.85rem; padding: 0.25rem 0; border-bottom: 1px solid var(--bg); }
    .memory-bank { margin-top: 1rem; }
    .memory-bank h3 { font-size: 1rem; color: var(--accent); margin-bottom: 0.5rem; }
    .memory-bank p { font-size: 0.9rem; color: var(--muted); margin-bottom: 0.5rem; }
    .tab-row { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    .tab-row button { margin-top: 0; flex: none; }
    .tab-row button.active { background: var(--muted); color: var(--text); }
    #progressScreen .card { margin-bottom: 1rem; }
    .intro-section { white-space: pre-line; line-height: 1.6; margin-bottom: 1rem; }
    .intro-section h3 { font-size: 1rem; color: var(--accent); margin-bottom: 0.5rem; }
    #introScreen .card { margin-bottom: 1rem; }
    .prepositions-list-card h3 { font-size: 1rem; color: var(--accent); margin: 1rem 0 0.5rem 0; }
    .prepositions-list-card .list-words { display: flex; flex-wrap: wrap; gap: 0.35rem; margin-bottom: 0.5rem; }
    .prepositions-list-card .list-words span { background: var(--bg); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.9rem; }
    .reference-phrasal-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-bottom: 1.5rem; }
    .reference-phrasal-table th, .reference-phrasal-table td { border: 1px solid var(--muted); padding: 0.4rem 0.6rem; text-align: left; vertical-align: top; }
    .reference-phrasal-table th { background: var(--bg); color: var(--accent); font-weight: 600; }
    .reference-phrasal-table td:first-child { white-space: nowrap; }
    @media print {
      body * { visibility: hidden; }
      .no-print-hide, .no-print-hide * { visibility: visible; }
      .no-print-hide { position: absolute; left: 0; top: 0; width: 100%; background: white; color: #111; padding: 1rem; }
      .no-print-hide .actions { display: none !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>English Grammar Check</h1>
    <p class="sub">Choose a topic and start the quiz.</p>

    <div id="menuScreen" class="card">
      <div id="menuQuiz">
        <div class="scores" id="scoresSummary"></div>
        <p style="margin-bottom: 0.5rem; color: var(--muted); font-size: 0.9rem;">Mixed cloze: find weak areas, then revise by topic.</p>
        <div class="actions" style="margin-bottom: 1rem;">
          <button type="button" id="startDiagnosticBtn" class="secondary">Quick grammar check</button>
          <button type="button" id="startMixedPracticeBtn" class="secondary">Mixed cloze practice</button>
        </div>
        <hr style="border: none; border-top: 1px solid var(--muted); margin: 1rem 0;" />
        <label for="topicSelect" id="topicLabel" class="hidden">Topic</label>
        <select id="topicSelect" class="hidden" style="margin-bottom: 0.5rem;"></select>
        <p style="margin-bottom: 0.5rem; color: var(--muted); font-size: 0.9rem;">Part 1: Intro, rules & test. Part 2: Practice. Part 3: Free practice.</p>
        <button type="button" id="startPart1Btn" class="secondary">Part 1: Intro, rules & test</button>
        <button type="button" id="startPart2Btn" class="secondary">Part 2: Practice</button>
        <button type="button" id="viewPrepositionsListBtn" class="secondary hidden">View preposition lists (print &amp; download)</button>
        <button type="button" id="viewPhrasalVerbsDictionaryBtn" class="secondary hidden">View phrasal verb dictionary (print &amp; download)</button>
        <hr style="border: none; border-top: 1px solid var(--muted); margin: 1rem 0;" />
        <label for="setSelect">Part 3: Free practice – choose a set</label>
        <select id="setSelect"></select>
        <label for="numQuestions">Number of questions (leave empty for all)</label>
        <input type="number" id="numQuestions" min="1" placeholder="All">
        <label><input type="checkbox" id="shuffleCheck"> Shuffle order</label>
        <div class="memory-bank" id="memoryBankSummary"></div>
        <button id="startBtn">Start quiz</button>
      </div>
    </div>

    <div style="margin-top: 1.5rem; margin-bottom: 1rem;">
      <button type="button" id="openReferenceBtn" class="secondary">Reference</button>
    </div>

    <div id="quizScreen" class="hidden">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;">
        <div class="progress" id="progress" style="margin-bottom: 0;"></div>
        <button type="button" id="exitQuizBtn" class="secondary" style="margin-top: 0; flex: none;">Exit quiz</button>
      </div>
      <div class="card question-block">
        <div class="question-text" id="questionText"></div>
        <div id="openBlock" class="hidden">
          <input type="text" id="openInput" placeholder="Type your answer">
        </div>
        <div id="mcBlock" class="options hidden"></div>
        <button type="button" id="submitBtn">Submit</button>
      </div>
      <div id="feedbackBlock" class="card hidden">
        <div id="feedbackText"></div>
        <div class="explanation" id="explanation"></div>
        <button id="nextBtn">Next</button>
      </div>
    </div>

    <div id="introScreen" class="hidden">
      <div class="card">
        <h2 id="introTitle"></h2>
        <div id="introContent"></div>
        <div id="introPrepositionsListWrap" class="hidden" style="margin-top: 0.75rem;">
          <button type="button" id="viewPrepositionsListFromIntroBtn" class="secondary">View preposition lists (print &amp; download)</button>
        </div>
        <div id="introPhrasalVerbsWrap" class="hidden" style="margin-top: 0.75rem;">
          <button type="button" id="viewPhrasalVerbsFromIntroBtn" class="secondary">View phrasal verb dictionary (top 50 + next 100)</button>
        </div>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.75rem;">
          <button type="button" id="introNextBtn">Next</button>
          <button type="button" id="introExitBtn" class="secondary">Back to menu</button>
        </div>
      </div>
    </div>

    <div id="sectionCompleteScreen" class="hidden">
      <div class="card">
        <h3 id="sectionCompleteTitle"></h3>
        <p id="sectionCompleteScore"></p>
        <div id="sectionCompleteCorrectBlock" class="hidden" style="margin-top: 1rem;">
          <h3 style="font-size: 1rem; color: var(--accent); margin-bottom: 0.5rem;">Correct spellings</h3>
          <div id="sectionCompleteCorrectList" class="summary" style="font-size: 0.9rem; line-height: 1.6;"></div>
        </div>
        <button type="button" id="sectionCompleteNextBtn">Next section</button>
      </div>
    </div>

    <div id="resultScreen" class="hidden">
      <div class="card">
        <h2 id="resultTitle">Quiz finished</h2>
        <p id="resultScore"></p>
        <div class="summary" id="ruleSummary"></div>
        <div id="wrongAnswersCorrectBlock" class="hidden" style="margin-top: 1rem;">
          <h3 style="font-size: 1rem; color: var(--accent); margin-bottom: 0.5rem;">Correct spellings</h3>
          <div id="wrongAnswersCorrectList" class="summary" style="font-size: 0.9rem; line-height: 1.6;"></div>
        </div>
        <div id="topicsToReviewBlock" class="hidden" style="margin-top: 1rem;">
          <h3 style="font-size: 1rem; color: var(--accent); margin-bottom: 0.5rem;">Topics to review</h3>
          <p style="font-size: 0.9rem; color: var(--muted); margin-bottom: 0.5rem;">You had errors in these areas. Choose a topic to revise the rules and practise.</p>
          <div id="topicsToReviewList" class="actions"></div>
        </div>
        <div class="actions">
          <button id="retryWrongBtn" class="secondary">Retry wrong answers</button>
          <button id="exportWrongBtn" class="secondary">Download wrong answers</button>
          <button id="backToMenuBtn">Back to menu</button>
        </div>
      </div>
    </div>

    <div id="prepositionsListScreen" class="hidden no-print-hide">
      <div class="card prepositions-list-card">
        <h2 id="prepositionsListTitle">Prepositions in English</h2>
        <div id="prepositionsListContent"></div>
        <div class="actions" style="margin-top: 1rem;">
          <button type="button" id="prepositionsListPrintBtn" class="secondary">Print list</button>
          <button type="button" id="prepositionsListDownloadBtn" class="secondary">Download as text</button>
          <button type="button" id="prepositionsListBackBtn">Back</button>
        </div>
      </div>
    </div>
    <div id="phrasalVerbsDictionaryScreen" class="hidden no-print-hide">
      <div class="card prepositions-list-card">
        <h2 id="phrasalVerbsDictionaryTitle">Phrasal verb dictionary</h2>
        <div id="phrasalVerbsDictionaryContent"></div>
        <div class="actions" style="margin-top: 1rem;">
          <button type="button" id="phrasalVerbsDictionaryPrintBtn" class="secondary">Print dictionary</button>
          <button type="button" id="phrasalVerbsDictionaryDownloadBtn" class="secondary">Download as text</button>
          <button type="button" id="phrasalVerbsDictionaryBackBtn">Back</button>
        </div>
      </div>
    </div>
    <div id="referenceScreen" class="hidden no-print-hide">
      <div class="card prepositions-list-card">
        <h2 id="referenceTitle">Reference</h2>
        <div id="referenceContent"></div>
        <div id="referenceActions" class="actions" style="margin-top: 1rem;">
          <span id="referencePrintDownloadWrap" class="hidden">
            <button type="button" id="referencePrintBtn" class="secondary">Print</button>
            <button type="button" id="referenceDownloadBtn" class="secondary">Download as text</button>
          </span>
          <button type="button" id="referenceBackBtn">Back</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'presentPerfectQuizScores';
    const MEMORY_KEY = 'presentPerfectQuizMemory';
    let topics = [];
    let currentTopic = { id: 'present_perfect', title: 'English Grammar Check', curriculum: 'curriculum.json', questions_key: 'sets' };
    let allQuestionsData = {};
    let setsData = {};
    let currentSetId = '';
    let currentSetTitle = '';
    let currentQuestions = [];
    let currentIndex = 0;
    let score = 0;
    let wrongIndices = [];
    let summary = '';
    let isRetryRound = false;
    let courseCurriculum = null;
    let coursePhase = null;
    let coursePart = null;
    let introSectionIndex = 0;
    let prepositionsListData = null;
    let prepositionsListReturnTo = 'menu';
    let phrasalVerbsDictionaryData = null;
    let phrasalVerbsDictionaryReturnTo = 'menu';
    const COURSE_ORDER = ['check', 'gapfill', 'errorcorrection', 'makesentence', 'makequestion'];
    const PART2_ORDER = ['gapfill', 'errorcorrection', 'makesentence', 'makequestion'];
    let part2Order = PART2_ORDER;
    let quizMode = 'normal';
    let wrongTopics = new Set();

    function questionHash(q) {
      const s = (q.question || q.prompt || '').trim();
      let h = 0;
      for (let i = 0; i < s.length; i++) h = ((h << 5) - h) + s.charCodeAt(i) | 0;
      return (h >>> 0).toString(36);
    }

    function loadScores() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : { history: [] };
      } catch { return { history: [] }; }
    }

    function loadMemoryBank() {
      try {
        const raw = localStorage.getItem(MEMORY_KEY);
        return raw ? JSON.parse(raw) : {};
      } catch { return {}; }
    }

    function saveMemoryBankEntry(key, correct) {
      const bank = loadMemoryBank();
      if (!bank[key]) bank[key] = { wrong: 0, right: 0, lastWrong: null };
      if (correct) bank[key].right++; else { bank[key].wrong++; bank[key].lastWrong = new Date().toISOString(); }
      localStorage.setItem(MEMORY_KEY, JSON.stringify(bank));
    }

    function saveScore(setId, setTitle, score, total) {
      const data = loadScores();
      data.history.push({ set_id: setId, set_title: setTitle, score, total, date: new Date().toISOString() });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function getLastBest(setId) {
      const data = loadScores();
      const forSet = (data.history || []).filter(e => e.set_id === setId);
      if (!forSet.length) return { last: null, best: null };
      const last = forSet[forSet.length - 1];
      const best = forSet.reduce((acc, e) => {
        if (!acc || (e.score / e.total) > (acc.score / acc.total)) return e;
        return acc;
      }, null);
      return { last: [last.score, last.total], best: [best.score, best.total] };
    }

    function getWeakSpotQuestions() {
      const bank = loadMemoryBank();
      const seen = new Set();
      const out = [];
      Object.values(setsData).forEach(s => {
        (s.questions || []).forEach(q => {
          const key = questionHash(q);
          if (bank[key] && bank[key].wrong > 0 && !seen.has(key)) {
            seen.add(key);
            out.push(q);
          }
        });
      });
      return out;
    }

    function getProgressStats() {
      const data = loadScores();
      const history = data.history || [];
      const total = history.length;
      if (total === 0) return { total: 0, avg: 0, thisWeek: 0, streak: 0 };
      const now = new Date();
      const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      const thisWeek = history.filter(e => new Date(e.date) >= weekAgo).length;
      let totalCorrect = 0, totalQuestions = 0;
      history.forEach(e => { totalCorrect += e.score; totalQuestions += e.total; });
      const avg = totalQuestions ? Math.round((100 * totalCorrect) / totalQuestions) : 0;
      let streak = 0;
      for (let i = history.length - 1; i >= 0; i--) {
        const pct = (100 * history[i].score) / history[i].total;
        if (pct >= 80) streak++; else break;
      }
      return { total, avg, thisWeek, streak };
    }

    function normalize(s) {
      return s.trim().toLowerCase().replace(/\s+/g, ' ');
    }

    function answerMatches(user, accepted) {
      const u = normalize(user);
      return accepted.some(a => normalize(a) === u);
    }

    function getBaseUrl() {
      return new URL('.', window.location.href).href;
    }

    async function loadQuestions() {
      const res = await fetch(new URL('questions.json?v=3', getBaseUrl()));
      if (!res.ok) throw new Error('Could not load questions.json');
      allQuestionsData = await res.json();
      setsData = allQuestionsData[currentTopic.questions_key] || allQuestionsData.sets || {};
    }

    function applyTopic() {
      setsData = allQuestionsData[currentTopic.questions_key] || allQuestionsData.sets || {};
    }

    function renderMenu() {
      const select = document.getElementById('setSelect');
      select.innerHTML = '';
      const weakSpots = getWeakSpotQuestions();
      if (weakSpots.length > 0) {
        const wOpt = document.createElement('option');
        wOpt.value = 'weakspots';
        wOpt.textContent = 'Practice weak spots (' + weakSpots.length + ' questions)';
        select.appendChild(wOpt);
      }
      const ids = Object.keys(setsData);
      ids.forEach(id => {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = setsData[id].title + ' (' + (setsData[id].questions?.length || 0) + ' questions)';
        select.appendChild(opt);
      });
      const allOpt = document.createElement('option');
      allOpt.value = 'all';
      allOpt.textContent = currentTopic.id === 'spelling' ? 'All sets combined (20 random questions)' : 'All sets combined';
      select.appendChild(allOpt);

      const summaryEl = document.getElementById('scoresSummary');
      const selVal = select.value;
      if (selVal === 'weakspots') {
        summaryEl.textContent = weakSpots.length + ' questions you\'ve got wrong before – practise them to improve.';
      } else {
        const lastBest = getLastBest(selVal);
        if (lastBest.last) {
          summaryEl.textContent = `Last: ${lastBest.last[0]}/${lastBest.last[1]}` +
            (lastBest.best && (lastBest.best[0] !== lastBest.last[0] || lastBest.best[1] !== lastBest.last[1])
              ? `  •  Best: ${lastBest.best[0]}/${lastBest.best[1]}` : '');
        } else {
          summaryEl.textContent = '';
        }
      }

      const memEl = document.getElementById('memoryBankSummary');
      const bank = loadMemoryBank();
      const wrongCount = Object.values(bank).filter(v => v.wrong > 0).length;
      if (wrongCount > 0) {
        memEl.innerHTML = '<p><strong>Memory bank:</strong> ' + wrongCount + ' question(s) to review. Choose "Practice weak spots" from Part 3 (Free practice) and start the quiz.</p>';
      } else {
        memEl.innerHTML = '';
      }

      document.getElementById('menuScreen').classList.remove('hidden');
      document.getElementById('quizScreen').classList.add('hidden');
      document.getElementById('resultScreen').classList.add('hidden');
      document.getElementById('introScreen').classList.add('hidden');
      document.getElementById('sectionCompleteScreen').classList.add('hidden');
      document.getElementById('prepositionsListScreen').classList.add('hidden');
      document.getElementById('phrasalVerbsDictionaryScreen').classList.add('hidden');
      document.getElementById('referenceScreen').classList.add('hidden');
      document.getElementById('menuQuiz').classList.remove('hidden');
      document.getElementById('viewPrepositionsListBtn').classList.add('hidden');
      document.getElementById('viewPhrasalVerbsDictionaryBtn').classList.add('hidden');
    }

    function renderPrepositionsListContent(data) {
      const title = data.title || 'Prepositions in English';
      document.getElementById('prepositionsListTitle').textContent = title;
      const content = document.getElementById('prepositionsListContent');
      content.innerHTML = '';
      const addList = (label, arr) => {
        if (!arr || !arr.length) return;
        const h3 = document.createElement('h3');
        h3.textContent = label;
        content.appendChild(h3);
        const div = document.createElement('div');
        div.className = 'list-words';
        arr.forEach(w => {
          const span = document.createElement('span');
          span.textContent = w;
          div.appendChild(span);
        });
        content.appendChild(div);
      };
      addList('Top 20 (most common)', data.top20 || []);
      addList('Top 50', data.top50 || []);
      addList('Complete list', data.complete || []);
    }

    function prepositionsListAsText(data) {
      const preps = data.prepositions || [];
      if (preps.length) {
        const lines = [(data.title || 'Prepositions in English'), '', 'Preposition\tCategory\tExample'];
        preps.forEach(entry => {
          lines.push((entry.preposition || '') + '\t' + (entry.category || '') + '\t' + (entry.example || ''));
        });
        return lines.join('\n');
      }
      return (data.title || 'Prepositions in English') + '\n\n(No list)';
    }

    async function showPrepositionsList(returnTo) {
      prepositionsListReturnTo = returnTo || 'menu';
      if (!prepositionsListData) {
        try {
          const res = await fetch(new URL('prepositions_list.json', getBaseUrl()));
          if (!res.ok) throw new Error('Could not load list');
          prepositionsListData = await res.json();
        } catch (e) {
          alert('Could not load preposition list. ' + e.message);
          return;
        }
      }
      renderPrepositionsListContent(prepositionsListData);
      document.getElementById('menuScreen').classList.add('hidden');
      document.getElementById('introScreen').classList.add('hidden');
      document.getElementById('prepositionsListScreen').classList.remove('hidden');
    }

    function hidePrepositionsList() {
      document.getElementById('prepositionsListScreen').classList.add('hidden');
      if (prepositionsListReturnTo === 'intro') {
        document.getElementById('introScreen').classList.remove('hidden');
      } else {
        document.getElementById('menuScreen').classList.remove('hidden');
      }
    }

    function renderPhrasalVerbsDictionaryContent(data) {
      const title = data.title || 'Phrasal verb dictionary';
      document.getElementById('phrasalVerbsDictionaryTitle').textContent = title;
      const content = document.getElementById('phrasalVerbsDictionaryContent');
      content.innerHTML = '';
      const addSection = (label, arr) => {
        if (!arr || !arr.length) return;
        const h3 = document.createElement('h3');
        h3.textContent = label;
        content.appendChild(h3);
        const list = document.createElement('div');
        list.className = 'phrasal-verb-list';
        arr.forEach(entry => {
          const div = document.createElement('div');
          div.className = 'phrasal-verb-entry';
          div.style.marginBottom = '0.5rem';
          div.innerHTML = '<strong>' + (entry.verb || '').replace(/&/g, '&amp;').replace(/</g, '&lt;') + '</strong> – ' + (entry.meaning || '').replace(/&/g, '&amp;').replace(/</g, '&lt;') + '. <span class="muted">' + (entry.example || '').replace(/&/g, '&amp;').replace(/</g, '&lt;') + '</span>';
          list.appendChild(div);
        });
        content.appendChild(list);
      };
      addSection('Top 50 (most common)', data.top50 || []);
      addSection('Next 100', data.next100 || []);
    }

    function phrasalVerbsDictionaryAsText(data) {
      const lines = [(data.title || 'Phrasal verb dictionary'), ''];
      const addSection = (label, arr) => {
        if (!arr || !arr.length) return;
        lines.push(label);
        lines.push('');
        arr.forEach(entry => {
          lines.push(entry.verb + ' – ' + entry.meaning + '. Example: ' + entry.example);
        });
        lines.push('');
      };
      addSection('Top 50 (most common)', data.top50 || []);
      addSection('Next 100', data.next100 || []);
      return lines.join('\n');
    }

    async function showPhrasalVerbsDictionary(returnTo) {
      phrasalVerbsDictionaryReturnTo = returnTo || 'menu';
      if (!phrasalVerbsDictionaryData) {
        try {
          const res = await fetch(new URL('phrasal_verbs_dictionary.json?v=3', getBaseUrl()));
          if (!res.ok) throw new Error('Could not load dictionary');
          phrasalVerbsDictionaryData = await res.json();
        } catch (e) {
          alert('Could not load phrasal verb dictionary. ' + e.message);
          return;
        }
      }
      renderPhrasalVerbsDictionaryContent(phrasalVerbsDictionaryData);
      document.getElementById('menuScreen').classList.add('hidden');
      document.getElementById('introScreen').classList.add('hidden');
      document.getElementById('phrasalVerbsDictionaryScreen').classList.remove('hidden');
    }

    function hidePhrasalVerbsDictionary() {
      document.getElementById('phrasalVerbsDictionaryScreen').classList.add('hidden');
      if (phrasalVerbsDictionaryReturnTo === 'intro') {
        document.getElementById('introScreen').classList.remove('hidden');
      } else {
        document.getElementById('menuScreen').classList.remove('hidden');
      }
    }

    let referenceInfinitiveIngData = null;
    let dependentPrepositionsData = null;
    let countableUncountableData = null;
    let referenceView = 'index';

    function renderReferenceIndex() {
      referenceView = 'index';
      document.getElementById('referenceTitle').textContent = 'Reference';
      const content = document.getElementById('referenceContent');
      content.innerHTML = '';
      const p = document.createElement('p');
      p.style.color = 'var(--muted)';
      p.style.marginBottom = '1rem';
      p.textContent = 'Choose a reference list:';
      content.appendChild(p);
      const btn1 = document.createElement('button');
      btn1.type = 'button';
      btn1.className = 'secondary';
      btn1.textContent = 'Infinitive and -ing form';
      btn1.style.marginBottom = '0.5rem';
      btn1.addEventListener('click', showReferenceInfinitiveIng);
      content.appendChild(btn1);
      const btn2 = document.createElement('button');
      btn2.type = 'button';
      btn2.className = 'secondary';
      btn2.textContent = 'Phrasal verb dictionary';
      btn2.style.marginBottom = '0.5rem';
      btn2.style.display = 'block';
      btn2.addEventListener('click', showReferencePhrasalVerbs);
      content.appendChild(btn2);
      const btn3 = document.createElement('button');
      btn3.type = 'button';
      btn3.className = 'secondary';
      btn3.textContent = 'Prepositions list';
      btn3.style.marginBottom = '0.5rem';
      btn3.style.display = 'block';
      btn3.addEventListener('click', showReferencePrepositions);
      content.appendChild(btn3);
      const btn4 = document.createElement('button');
      btn4.type = 'button';
      btn4.className = 'secondary';
      btn4.textContent = 'Dependent prepositions: Verbs';
      btn4.style.marginBottom = '0.5rem';
      btn4.style.display = 'block';
      btn4.addEventListener('click', () => showReferenceDependentSection('verbs'));
      content.appendChild(btn4);
      const btn5 = document.createElement('button');
      btn5.type = 'button';
      btn5.className = 'secondary';
      btn5.textContent = 'Dependent prepositions: Nouns';
      btn5.style.marginBottom = '0.5rem';
      btn5.style.display = 'block';
      btn5.addEventListener('click', () => showReferenceDependentSection('nouns'));
      content.appendChild(btn5);
      const btn6 = document.createElement('button');
      btn6.type = 'button';
      btn6.className = 'secondary';
      btn6.textContent = 'Dependent prepositions: Adjectives';
      btn6.style.marginBottom = '0.5rem';
      btn6.style.display = 'block';
      btn6.addEventListener('click', () => showReferenceDependentSection('adjectives'));
      content.appendChild(btn6);
      const btn7 = document.createElement('button');
      btn7.type = 'button';
      btn7.className = 'secondary';
      btn7.textContent = 'Preposition + verb compound nouns';
      btn7.style.marginBottom = '0.5rem';
      btn7.style.display = 'block';
      btn7.addEventListener('click', () => showReferenceDependentSection('compound_nouns'));
      content.appendChild(btn7);
      const btn8 = document.createElement('button');
      btn8.type = 'button';
      btn8.className = 'secondary';
      btn8.textContent = 'Uncountable nouns & always plural';
      btn8.style.marginBottom = '0.5rem';
      btn8.style.display = 'block';
      btn8.addEventListener('click', showReferenceCountableUncountable);
      content.appendChild(btn8);
      document.getElementById('referencePrintDownloadWrap').classList.add('hidden');
      document.getElementById('referenceBackBtn').textContent = 'Back';
    }

    function renderReferencePrepositionsContent(data) {
      if (!data) return;
      referenceView = 'prepositions';
      document.getElementById('referenceTitle').textContent = data.title || 'Prepositions in English';
      const content = document.getElementById('referenceContent');
      content.innerHTML = '';
      const esc = (s) => (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const preps = data.prepositions || [];
      if (preps.length) {
        const table = document.createElement('table');
        table.className = 'reference-phrasal-table';
        table.setAttribute('border', '1');
        table.innerHTML = '<thead><tr><th>Preposition</th><th>Category</th><th>Example</th></tr></thead><tbody></tbody>';
        const tbody = table.querySelector('tbody');
        preps.forEach(entry => {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td>' + esc(entry.preposition) + '</td><td>' + esc(entry.category) + '</td><td>' + esc(entry.example) + '</td>';
          tbody.appendChild(tr);
        });
        content.appendChild(table);
      }
      document.getElementById('referencePrintDownloadWrap').classList.remove('hidden');
      document.getElementById('referenceBackBtn').textContent = 'Back to Reference';
    }

    async function showReferencePrepositions() {
      if (!prepositionsListData) {
        try {
          const res = await fetch(new URL('prepositions_list.json', getBaseUrl()));
          if (!res.ok) throw new Error('Could not load list');
          prepositionsListData = await res.json();
        } catch (e) {
          alert('Could not load preposition list. ' + e.message);
          return;
        }
      }
      renderReferencePrepositionsContent(prepositionsListData);
    }

    const DEPENDENT_SECTION_VIEWS = { verbs: 'dependent_verbs', nouns: 'dependent_nouns', adjectives: 'dependent_adjectives', compound_nouns: 'compound_nouns' };

    function getParticleFromPhrase(phrase) {
      if (!phrase || typeof phrase !== 'string') return '';
      const last = phrase.trim().split(/\s+/).pop() || '';
      const first = last.split(/\s*\/\s*/)[0].trim();
      return first || last;
    }

    const COMPOUND_PREFIXES = ['under', 'over', 'with', 'out', 'down', 'up', 'on', 'off', 'by', 'in'];

    function getPrefixForCompound(word) {
      if (!word || typeof word !== 'string') return '';
      const w = word.toLowerCase();
      for (let i = 0; i < COMPOUND_PREFIXES.length; i++) {
        if (w.indexOf(COMPOUND_PREFIXES[i]) === 0) return COMPOUND_PREFIXES[i];
      }
      return '';
    }

    function groupByParticle(arr, getParticle) {
      const groups = {};
      (arr || []).forEach(entry => {
        const p = getParticle(entry);
        if (!groups[p]) groups[p] = [];
        groups[p].push(entry);
      });
      return groups;
    }

    function renderReferenceDependentSection(data, section) {
      if (!data) return;
      referenceView = DEPENDENT_SECTION_VIEWS[section] || 'dependent_verbs';
      const titles = { verbs: data.title_verbs, nouns: data.title_nouns, adjectives: data.title_adjectives, compound_nouns: data.title_compound_nouns };
      document.getElementById('referenceTitle').textContent = titles[section] || 'Dependent prepositions';
      const content = document.getElementById('referenceContent');
      content.innerHTML = '';
      const esc = (s) => (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const addGroup = (particle, entries, cols) => {
        const h3 = document.createElement('h3');
        h3.textContent = 'Particle: ' + particle;
        h3.style.fontSize = '1rem';
        h3.style.color = 'var(--accent)';
        h3.style.marginTop = '1rem';
        h3.style.marginBottom = '0.5rem';
        content.appendChild(h3);
        const table = document.createElement('table');
        table.className = 'reference-phrasal-table';
        table.setAttribute('border', '1');
        const headers = cols.map(c => c.charAt(0).toUpperCase() + c.slice(1)).join('</th><th>');
        table.innerHTML = '<thead><tr><th>' + headers + '</th></tr></thead><tbody></tbody>';
        const tbody = table.querySelector('tbody');
        entries.forEach(entry => {
          const cells = cols.map(c => esc(entry[c] || ''));
          const tr = document.createElement('tr');
          tr.innerHTML = '<td>' + cells.join('</td><td>') + '</td>';
          tbody.appendChild(tr);
        });
        content.appendChild(table);
      };
      if (section === 'verbs') {
        const arr = data.dependent_verbs || [];
        const groups = groupByParticle(arr, e => getParticleFromPhrase(e.phrase));
        const particles = Object.keys(groups).filter(Boolean).sort();
        particles.forEach(particle => addGroup(particle, groups[particle], ['phrase', 'meaning', 'example']));
      } else if (section === 'nouns') {
        const arr = data.dependent_nouns || [];
        const groups = groupByParticle(arr, e => getParticleFromPhrase(e.phrase));
        const particles = Object.keys(groups).filter(Boolean).sort();
        particles.forEach(particle => addGroup(particle, groups[particle], ['phrase', 'example']));
      } else if (section === 'adjectives') {
        const arr = data.dependent_adjectives || [];
        const groups = groupByParticle(arr, e => getParticleFromPhrase(e.phrase));
        const particles = Object.keys(groups).filter(Boolean).sort();
        particles.forEach(particle => addGroup(particle, groups[particle], ['phrase', 'meaning', 'example']));
      } else if (section === 'compound_nouns') {
        const arr = data.compound_nouns || [];
        const groups = groupByParticle(arr, e => getPrefixForCompound(e.word));
        const particles = Object.keys(groups).filter(Boolean).sort();
        particles.forEach(particle => addGroup(particle, groups[particle], ['word', 'meaning', 'example']));
      }
      document.getElementById('referencePrintDownloadWrap').classList.remove('hidden');
      document.getElementById('referenceBackBtn').textContent = 'Back to Reference';
    }

    async function showReferenceDependentSection(section) {
      if (!dependentPrepositionsData) {
        try {
          const res = await fetch(new URL('reference_dependent_prepositions.json', getBaseUrl()));
          if (!res.ok) throw new Error('Could not load list');
          dependentPrepositionsData = await res.json();
        } catch (e) {
          alert('Could not load list. ' + e.message);
          return;
        }
      }
      renderReferenceDependentSection(dependentPrepositionsData, section);
    }

    function dependentPrepositionsSectionAsText(data, section) {
      if (!data) return '';
      const titles = { verbs: data.title_verbs, nouns: data.title_nouns, adjectives: data.title_adjectives, compound_nouns: data.title_compound_nouns };
      const lines = [(titles[section] || section), ''];
      const addGroup = (particle, entries, cols) => {
        lines.push('Particle: ' + particle);
        lines.push(cols.join('\t'));
        entries.forEach(entry => { lines.push(cols.map(c => entry[c] || '').join('\t')); });
        lines.push('');
      };
      if (section === 'verbs') {
        const arr = data.dependent_verbs || [];
        const groups = groupByParticle(arr, e => getParticleFromPhrase(e.phrase));
        Object.keys(groups).filter(Boolean).sort().forEach(particle => addGroup(particle, groups[particle], ['phrase', 'meaning', 'example']));
      } else if (section === 'nouns') {
        const arr = data.dependent_nouns || [];
        const groups = groupByParticle(arr, e => getParticleFromPhrase(e.phrase));
        Object.keys(groups).filter(Boolean).sort().forEach(particle => addGroup(particle, groups[particle], ['phrase', 'example']));
      } else if (section === 'adjectives') {
        const arr = data.dependent_adjectives || [];
        const groups = groupByParticle(arr, e => getParticleFromPhrase(e.phrase));
        Object.keys(groups).filter(Boolean).sort().forEach(particle => addGroup(particle, groups[particle], ['phrase', 'meaning', 'example']));
      } else if (section === 'compound_nouns') {
        const arr = data.compound_nouns || [];
        const groups = groupByParticle(arr, e => getPrefixForCompound(e.word));
        Object.keys(groups).filter(Boolean).sort().forEach(particle => addGroup(particle, groups[particle], ['word', 'meaning', 'example']));
      }
      return lines.join('\n');
    }

    function renderReferenceCountableUncountableContent(data) {
      if (!data) return;
      referenceView = 'countable_uncountable';
      document.getElementById('referenceTitle').textContent = data.title || 'Uncountable nouns & always plural';
      const content = document.getElementById('referenceContent');
      content.innerHTML = '';
      const esc = (s) => (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const addSection = (label, arr, cols) => {
        if (!arr || !arr.length) return;
        const h3 = document.createElement('h3');
        h3.textContent = label;
        h3.style.fontSize = '1rem';
        h3.style.color = 'var(--accent)';
        h3.style.marginTop = '1rem';
        h3.style.marginBottom = '0.5rem';
        content.appendChild(h3);
        const table = document.createElement('table');
        table.className = 'reference-phrasal-table';
        table.setAttribute('border', '1');
        const headers = cols.map(c => c.charAt(0).toUpperCase() + c.slice(1)).join('</th><th>');
        table.innerHTML = '<thead><tr><th>' + headers + '</th></tr></thead><tbody></tbody>';
        const tbody = table.querySelector('tbody');
        arr.forEach(entry => {
          const cells = cols.map(c => esc(entry[c] || ''));
          const tr = document.createElement('tr');
          tr.innerHTML = '<td>' + cells.join('</td><td>') + '</td>';
          tbody.appendChild(tr);
        });
        content.appendChild(table);
      };
      addSection('30 common uncountable nouns', data.uncountable || [], ['word', 'note']);
      addSection('Nouns that are always plural (20)', data.always_plural || [], ['word', 'note']);
      document.getElementById('referencePrintDownloadWrap').classList.remove('hidden');
      document.getElementById('referenceBackBtn').textContent = 'Back to Reference';
    }

    async function showReferenceCountableUncountable() {
      if (!countableUncountableData) {
        try {
          const res = await fetch(new URL('reference_countable_uncountable.json', getBaseUrl()));
          if (!res.ok) throw new Error('Could not load list');
          countableUncountableData = await res.json();
        } catch (e) {
          alert('Could not load list. ' + e.message);
          return;
        }
      }
      renderReferenceCountableUncountableContent(countableUncountableData);
    }

    function countableUncountableAsText(data) {
      if (!data) return '';
      const lines = [(data.title || 'Uncountable nouns & always plural'), ''];
      const addTable = (label, arr) => {
        if (!arr || !arr.length) return;
        lines.push(label);
        lines.push('Word\tNote');
        arr.forEach(entry => { lines.push((entry.word || '') + '\t' + (entry.note || '')); });
        lines.push('');
      };
      addTable('30 common uncountable nouns', data.uncountable || []);
      addTable('Nouns that are always plural (20)', data.always_plural || []);
      return lines.join('\n');
    }

    let phrasalVerbListView = 'sections';

    function renderReferencePhrasalVerbsContent(data, viewMode) {
      if (!data) return;
      if (viewMode !== undefined) phrasalVerbListView = viewMode;
      referenceView = 'phrasal_verbs';
      document.getElementById('referenceTitle').textContent = data.title || 'Phrasal verb dictionary';
      const content = document.getElementById('referenceContent');
      content.innerHTML = '';
      const esc = (s) => (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const addTable = (arr) => {
        if (!arr || !arr.length) return null;
        const table = document.createElement('table');
        table.className = 'reference-phrasal-table';
        table.setAttribute('border', '1');
        table.innerHTML = '<thead><tr><th>Phrasal verb</th><th>Definition</th><th>Example</th></tr></thead><tbody></tbody>';
        const tbody = table.querySelector('tbody');
        arr.forEach(entry => {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td>' + esc(entry.verb) + '</td><td>' + esc(entry.meaning) + '</td><td>' + esc(entry.example) + '</td>';
          tbody.appendChild(tr);
        });
        return table;
      };
      const toggleBtn = document.createElement('button');
      toggleBtn.type = 'button';
      toggleBtn.className = 'secondary';
      toggleBtn.style.marginBottom = '1rem';
      if (phrasalVerbListView === 'sections') {
        toggleBtn.textContent = 'Sort by particle';
        toggleBtn.addEventListener('click', () => renderReferencePhrasalVerbsContent(data, 'byParticle'));
      } else {
        toggleBtn.textContent = 'Show by section (Top 50 / Next 100)';
        toggleBtn.addEventListener('click', () => renderReferencePhrasalVerbsContent(data, 'sections'));
      }
      content.appendChild(toggleBtn);

      if (phrasalVerbListView === 'sections') {
        const addSection = (label, arr) => {
          if (!arr || !arr.length) return;
          const h3 = document.createElement('h3');
          h3.textContent = label;
          h3.style.fontSize = '1rem';
          h3.style.color = 'var(--accent)';
          h3.style.marginTop = '1rem';
          h3.style.marginBottom = '0.5rem';
          content.appendChild(h3);
          content.appendChild(addTable(arr));
        };
        addSection('Top 50 (most common)', data.top50 || []);
        addSection('Next 100', data.next100 || []);
      } else {
        const all = [...(data.top50 || []), ...(data.next100 || [])];
        const byParticle = {};
        all.forEach(entry => {
          const parts = (entry.verb || '').trim().split(/\s+/);
          const particle = parts.length > 1 ? parts[parts.length - 1] : '';
          if (!byParticle[particle]) byParticle[particle] = [];
          byParticle[particle].push(entry);
        });
        const particles = Object.keys(byParticle).filter(p => p).sort();
        particles.forEach(particle => {
          const h3 = document.createElement('h3');
          h3.textContent = 'Particle: ' + particle;
          h3.style.fontSize = '1rem';
          h3.style.color = 'var(--accent)';
          h3.style.marginTop = '1rem';
          h3.style.marginBottom = '0.5rem';
          content.appendChild(h3);
          const table = addTable(byParticle[particle]);
          if (table) content.appendChild(table);
        });
      }
      document.getElementById('referencePrintDownloadWrap').classList.remove('hidden');
      document.getElementById('referenceBackBtn').textContent = 'Back to Reference';
    }

    async function showReferencePhrasalVerbs() {
      if (!phrasalVerbsDictionaryData) {
        try {
          const res = await fetch(new URL('phrasal_verbs_dictionary.json?v=3', getBaseUrl()));
          if (!res.ok) throw new Error('Could not load dictionary');
          phrasalVerbsDictionaryData = await res.json();
        } catch (e) {
          alert('Could not load phrasal verb dictionary. ' + e.message);
          return;
        }
      }
      renderReferencePhrasalVerbsContent(phrasalVerbsDictionaryData);
    }

    function renderReferenceInfinitiveIngContent(data) {
      if (!data) return;
      referenceView = 'infinitive_ing';
      document.getElementById('referenceTitle').textContent = data.title || 'Infinitive and -ing: verb lists';
      const content = document.getElementById('referenceContent');
      content.innerHTML = '';
      const addList = (label, arr) => {
        if (!arr || !arr.length) return;
        const h3 = document.createElement('h3');
        h3.textContent = label;
        content.appendChild(h3);
        const div = document.createElement('div');
        div.className = 'list-words';
        arr.forEach(w => {
          const span = document.createElement('span');
          span.textContent = w;
          div.appendChild(span);
        });
        content.appendChild(div);
      };
      if (data.intro) {
        const p = document.createElement('p');
        p.style.whiteSpace = 'pre-line';
        p.style.marginBottom = '1rem';
        p.style.color = 'var(--muted)';
        const introRaw = data.intro.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
        p.innerHTML = introRaw.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        content.appendChild(p);
      }
      addList('Verbs always followed by to-infinitive (to do, to go)', data.verbs_to || []);
      addList('Verbs always followed by -ing (doing, going)', data.verbs_ing || []);
      addList('Verbs + both (same or similar meaning)', data.verbs_both_same || []);
      addList('Verbs + both (different meaning – learn each pair)', data.verbs_both_different || []);
      document.getElementById('referencePrintDownloadWrap').classList.remove('hidden');
      document.getElementById('referenceBackBtn').textContent = 'Back to Reference';
    }

    function referenceAsText(data) {
      if (!data) return '';
      const lines = [(data.title || 'Reference'), '', (data.intro || '').replace(/\*\*(.*?)\*\*/g, '$1'), ''];
      const addSection = (label, arr) => {
        if (!arr || !arr.length) return;
        lines.push(label);
        lines.push(arr.join(', '));
        lines.push('');
      };
      addSection('Verbs always followed by to-infinitive:', data.verbs_to || []);
      addSection('Verbs always followed by -ing:', data.verbs_ing || []);
      addSection('Verbs + both (same meaning):', data.verbs_both_same || []);
      addSection('Verbs + both (different meaning):', data.verbs_both_different || []);
      return lines.join('\n');
    }

    async function showReference() {
      renderReferenceIndex();
      document.getElementById('menuScreen').classList.add('hidden');
      document.getElementById('introScreen').classList.add('hidden');
      document.getElementById('referenceScreen').classList.remove('hidden');
    }

    async function showReferenceInfinitiveIng() {
      if (!referenceInfinitiveIngData) {
        try {
          const res = await fetch(new URL('reference_infinitive_ing.json', getBaseUrl()));
          if (!res.ok) throw new Error('Could not load reference');
          referenceInfinitiveIngData = await res.json();
        } catch (e) {
          alert('Could not load reference. ' + e.message);
          return;
        }
      }
      renderReferenceInfinitiveIngContent(referenceInfinitiveIngData);
    }

    function hideReference() {
      document.getElementById('referenceScreen').classList.add('hidden');
      document.getElementById('menuScreen').classList.remove('hidden');
    }

    function onReferenceBackClick() {
      if (referenceView === 'infinitive_ing' || referenceView === 'phrasal_verbs' || referenceView === 'prepositions' || referenceView === 'dependent_verbs' || referenceView === 'dependent_nouns' || referenceView === 'dependent_adjectives' || referenceView === 'compound_nouns' || referenceView === 'countable_uncountable') {
        renderReferenceIndex();
      } else {
        hideReference();
      }
    }

    function showIntroSection(index) {
      const intro = courseCurriculum.intro || {};
      const sections = intro.sections || [];
      if (index >= sections.length) {
        document.getElementById('introScreen').classList.add('hidden');
        if (coursePart === 1) startCourseSection('check');
        return;
      }
      document.getElementById('introTitle').textContent = sections[index].title || 'Introduction';
      const introRaw = (sections[index].content || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
      const introHtml = introRaw.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      document.getElementById('introContent').innerHTML = '<div class="intro-section">' + introHtml + '</div>';
      document.getElementById('introNextBtn').textContent = index < sections.length - 1 ? 'Next' : 'Start test';
      introSectionIndex = index;
      document.getElementById('introPrepositionsListWrap').classList.add('hidden');
      document.getElementById('introPhrasalVerbsWrap').classList.add('hidden');
    }

    function startCourseSection(phase) {
      coursePhase = phase;
      let questions = [];
      let title = '';
      if (phase === 'check') {
        const check = courseCurriculum.check || {};
        questions = (check.questions || []).slice();
        title = check.title || 'Test your understanding';
        currentSetId = 'course_check';
      } else {
        const practice = courseCurriculum.practice || {};
        const section = practice[phase];
        if (!section || !section.questions) {
          advanceCourseToNext();
          return;
        }
        questions = section.questions.slice();
        if (coursePart === 2 && questions.length > 1) {
          for (let i = questions.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [questions[i], questions[j]] = [questions[j], questions[i]];
          }
        }
        title = section.title || phase;
        currentSetId = 'course_' + phase;
      }
      currentSetTitle = title;
      currentQuestions = questions;
      currentIndex = 0;
      score = 0;
      wrongIndices = [];
      isRetryRound = false;
      document.getElementById('sectionCompleteScreen').classList.add('hidden');
      document.getElementById('quizScreen').classList.remove('hidden');
      document.getElementById('feedbackBlock').classList.add('hidden');
      document.getElementById('exitQuizBtn').textContent = coursePart === 1 ? 'Exit test' : 'Exit quiz';
      showQuestion();
    }

    function advanceCourseToNext() {
      document.getElementById('sectionCompleteScreen').classList.add('hidden');
      if (coursePart === 1) {
        coursePart = null;
        coursePhase = null;
        renderMenu();
        return;
      }
      const order = coursePart === 2 ? part2Order : COURSE_ORDER;
      const idx = order.indexOf(coursePhase);
      const nextPhase = idx >= 0 && idx < order.length - 1 ? order[idx + 1] : null;
      if (!nextPhase) {
        coursePhase = null;
        if (coursePart === 2) {
          document.getElementById('resultScreen').classList.remove('hidden');
          document.getElementById('resultScore').textContent = 'Part 2 complete! Well done.';
          const sectionNames = part2Order.map(function(k) {
            const s = courseCurriculum.practice && courseCurriculum.practice[k];
            return (s && s.title) ? s.title.replace(/^Practice: Gap fill –?\s*/i, '').trim() : k.replace(/_/g, ' ');
          });
          document.getElementById('ruleSummary').textContent = 'You have finished Practice: ' + sectionNames.join(', ') + '.';
          document.getElementById('retryWrongBtn').classList.add('hidden');
          document.getElementById('exportWrongBtn').classList.add('hidden');
          coursePart = null;
        }
        return;
      }
      const practice = courseCurriculum.practice || {};
      const section = practice[nextPhase];
      if (!section || !section.questions || section.questions.length === 0) {
        advanceCourseToNext();
        return;
      }
      startCourseSection(nextPhase);
    }

    async function startPart1() {
      try {
        const res = await fetch(new URL(currentTopic.curriculum + '?v=3', getBaseUrl()));
        if (!res.ok) throw new Error('Could not load ' + currentTopic.curriculum);
        courseCurriculum = await res.json();
      } catch (e) {
        const msg = window.location.protocol === 'file:' ? 'Could not load curriculum. Open the app via a local server (e.g. http://localhost:8080), not by opening the file directly.' : ('Could not load curriculum. ' + e.message);
      alert(msg);
        return;
      }
      coursePart = 1;
      document.getElementById('menuScreen').classList.add('hidden');
      document.getElementById('introScreen').classList.remove('hidden');
      introSectionIndex = 0;
      showIntroSection(0);
    }

    async function startPart2() {
      try {
        const res = await fetch(new URL(currentTopic.curriculum + '?v=3', getBaseUrl()));
        if (!res.ok) throw new Error('Could not load ' + currentTopic.curriculum);
        courseCurriculum = await res.json();
      } catch (e) {
        const msg = window.location.protocol === 'file:' ? 'Could not load curriculum. Open the app via a local server (e.g. http://localhost:8080), not by opening the file directly.' : ('Could not load curriculum. ' + e.message);
      alert(msg);
        return;
      }
      coursePart = 2;
      part2Order = courseCurriculum.practice_order || PART2_ORDER;
      document.getElementById('menuScreen').classList.add('hidden');
      if (!part2Order.length) { renderMenu(); return; }
      const practice = courseCurriculum.practice || {};
      const first = part2Order[0];
      const section = practice[first];
      if (!section || !section.questions || section.questions.length === 0) {
        renderMenu();
        return;
      }
      startCourseSection(first);
    }

    async function startDiagnostic() {
      let allData;
      try {
        const res = await fetch(new URL('questions.json?v=3', getBaseUrl()));
        if (!res.ok) throw new Error('Could not load questions');
        allData = await res.json();
      } catch (e) {
        alert('Could not load Quick grammar check. ' + e.message);
        return;
      }
      const pool = [];
      (topics || []).forEach(function(t) {
        const key = t.questions_key || t.id;
        const sets = allData[key];
        if (!sets || typeof sets !== 'object') return;
        Object.values(sets).forEach(function(set) {
          const qs = set.questions || [];
          qs.forEach(function(q) {
            pool.push(Object.assign({}, q, { topic: t.id }));
          });
        });
      });
      for (let i = pool.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }
      const max = Math.min(50, pool.length);
      currentQuestions = pool.slice(0, max);
      currentSetId = 'diagnostic';
      currentSetTitle = 'Quick grammar check';
      summary = '50 questions from all topics (random order). Wrong answers point to topics you need to revise.';
      currentIndex = 0;
      score = 0;
      wrongIndices = [];
      isRetryRound = false;
      quizMode = 'diagnostic';
      wrongTopics = new Set();
      document.getElementById('menuScreen').classList.add('hidden');
      document.getElementById('quizScreen').classList.remove('hidden');
      document.getElementById('feedbackBlock').classList.add('hidden');
      document.getElementById('exitQuizBtn').textContent = 'Exit quiz';
      showQuestion();
    }

    async function startMixedPractice() {
      let data;
      try {
        const res = await fetch(new URL('mixed_cloze.json?v=3', getBaseUrl()));
        if (!res.ok) throw new Error('Could not load mixed cloze');
        data = await res.json();
      } catch (e) {
        alert('Could not load mixed practice. ' + e.message);
        return;
      }
      const questions = (data.questions || []).slice();
      for (let i = questions.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [questions[i], questions[j]] = [questions[j], questions[i]];
      }
      currentQuestions = questions;
      currentSetId = 'mixed_practice';
      currentSetTitle = data.title_practice || 'Mixed cloze practice';
      summary = data.summary_practice || '';
      currentIndex = 0;
      score = 0;
      wrongIndices = [];
      isRetryRound = false;
      quizMode = 'practice';
      wrongTopics = new Set();
      document.getElementById('menuScreen').classList.add('hidden');
      document.getElementById('quizScreen').classList.remove('hidden');
      document.getElementById('feedbackBlock').classList.add('hidden');
      document.getElementById('exitQuizBtn').textContent = 'Exit quiz';
      showQuestion();
    }

    function startQuiz() {
      coursePhase = null;
      quizMode = 'normal';
      wrongTopics = new Set();
      const setSelect = document.getElementById('setSelect');
      const setId = setSelect.value;
      const numInput = document.getElementById('numQuestions');
      let questions;
      if (setId === 'weakspots') {
        questions = getWeakSpotQuestions();
        if (questions.length === 0) { alert('No weak spots yet. Do a quiz and get some wrong to build your memory bank.'); return; }
        for (let i = questions.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [questions[i], questions[j]] = [questions[j], questions[i]];
        }
      } else {
        questions = setId === 'all'
          ? Object.values(setsData).flatMap(s => s.questions || [])
          : [...(setsData[setId]?.questions || [])];
        if (document.getElementById('shuffleCheck').checked || (currentTopic.id === 'spelling' && setId === 'all')) {
          for (let i = questions.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [questions[i], questions[j]] = [questions[j], questions[i]];
          }
        }
        if (currentTopic.id === 'spelling' && setId === 'all') {
          questions = questions.slice(0, 20);
        }
      }
      const max = (currentTopic.id === 'spelling' && setId === 'all') ? questions.length : (numInput.value ? Math.min(parseInt(numInput.value, 10) || questions.length, questions.length) : questions.length);
      questions = questions.slice(0, max);
      currentQuestions = questions;
      currentSetId = setId;
      currentSetTitle = setId === 'weakspots' ? 'Practice weak spots' : (setId === 'all' ? 'All sets combined' : (setsData[setId]?.title || setId));
      summary = setId === 'weakspots' ? 'These are questions you got wrong before. Keep practising!' : (setId === 'all' ? (currentTopic.id === 'spelling' ? '20 random questions from all spelling sets.' : 'Mixed practice from all sets.') : (setsData[setId]?.summary || ''));
      currentIndex = 0;
      score = 0;
      wrongIndices = [];
      isRetryRound = false;

      document.getElementById('menuScreen').classList.add('hidden');
      document.getElementById('quizScreen').classList.remove('hidden');
      document.getElementById('feedbackBlock').classList.add('hidden');
      document.getElementById('exitQuizBtn').textContent = 'Exit quiz';
      showQuestion();
    }

    function showQuestion() {
      const q = currentQuestions[currentIndex];
      const total = currentQuestions.length;
      document.getElementById('progress').textContent = `Question ${currentIndex + 1} of ${total}`;
      const promptText = (q.prompt || q.question || '').replace(/^\d+\.\s*/, '').trim();
      document.getElementById('questionText').textContent = promptText;
      document.getElementById('openBlock').classList.add('hidden');
      document.getElementById('mcBlock').classList.add('hidden');
      document.getElementById('openInput').value = '';
      document.getElementById('submitBtn').classList.remove('hidden');
      document.getElementById('feedbackBlock').classList.add('hidden');

      if (q.type === 'mc') {
        const mcBlock = document.getElementById('mcBlock');
        mcBlock.classList.remove('hidden');
        mcBlock.innerHTML = '';
        const letters = ['a', 'b', 'c', 'd'];
        Object.entries(q.options || {}).forEach(([key, text]) => {
          const div = document.createElement('div');
          div.className = 'option';
          div.dataset.option = key;
          div.textContent = key + ') ' + text;
          div.addEventListener('click', () => {
            mcBlock.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
            div.classList.add('selected');
            selectedMc = key;
          });
          mcBlock.appendChild(div);
        });
        selectedMc = null;
      } else {
        document.getElementById('openBlock').classList.remove('hidden');
        document.getElementById('openInput').focus();
      }
    }

    let selectedMc = null;

    function submitAnswer() {
      const q = currentQuestions[currentIndex];
      let correct = false;

      if (q.type === 'mc') {
        correct = selectedMc === q.correct_option;
        document.getElementById('mcBlock').querySelectorAll('.option').forEach(o => {
          o.classList.remove('selected');
          if (o.dataset.option === q.correct_option) o.classList.add('correct');
          else if (o.dataset.option === selectedMc && !correct) o.classList.add('wrong');
        });
      } else {
        const userAnswer = document.getElementById('openInput').value.trim();
        correct = answerMatches(userAnswer, q.answers || []);
      }

      if (correct) score++; else {
        wrongIndices.push(currentIndex);
        if (q.topic) wrongTopics.add(q.topic);
      }
      saveMemoryBankEntry(questionHash(q), correct);

      const correctAnswerText = q.type === 'mc' ? (q.options && q.options[q.correct_option]) : (q.answers && q.answers[0]);
      const raw = (q.explanation || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const explanationHtml = raw.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      if (correct) {
        document.getElementById('feedbackText').innerHTML = '<span class="result-ok">Correct!</span>';
        document.getElementById('explanation').innerHTML = explanationHtml ? '<span class="explanation-label">Explanation:</span> ' + explanationHtml : '';
      } else {
        document.getElementById('feedbackText').innerHTML =
          '<span class="result-fail">Incorrect.</span>' +
          (correctAnswerText ? '<p class="correct-answer-line"><strong>Correct answer:</strong> ' + correctAnswerText + '</p>' : '') +
          (explanationHtml ? '<p class="explanation-label">Why?</p>' : '');
        document.getElementById('explanation').innerHTML = explanationHtml || '';
      }
      document.getElementById('submitBtn').classList.add('hidden');
      document.getElementById('feedbackBlock').classList.remove('hidden');
      document.getElementById('nextBtn').focus();
    }

    function nextQuestion() {
      currentIndex++;
      if (currentIndex >= currentQuestions.length) {
        finishQuiz();
        return;
      }
      showQuestion();
    }

    function buildSpellingCorrectAnswersHtml() {
      if (!currentTopic || currentTopic.id !== 'spelling' || wrongIndices.length === 0) return '';
      const lines = [];
      wrongIndices.forEach(i => {
        const q = currentQuestions[i];
        const correct = q.type === 'mc' ? (q.options && q.options[q.correct_option]) : (q.answers && q.answers[0]);
        if (correct) lines.push('<p style="margin: 0.5rem 0;"><strong>Correct:</strong> ' + String(correct).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</p>');
      });
      return lines.join('');
    }

    function finishQuiz() {
      if (!isRetryRound) saveScore(currentSetId, currentSetTitle, score, currentQuestions.length);
      document.getElementById('quizScreen').classList.add('hidden');
      const isSpellingWithWrong = currentTopic && currentTopic.id === 'spelling' && wrongIndices.length > 0;
      const correctAnswersHtml = isSpellingWithWrong ? buildSpellingCorrectAnswersHtml() : '';
      if (coursePhase) {
        document.getElementById('sectionCompleteTitle').textContent = coursePart === 1 ? 'Part 1 complete' : (currentSetTitle + ' – complete');
        document.getElementById('sectionCompleteScore').textContent = 'Score: ' + score + ' / ' + currentQuestions.length;
        const sectionCorrectBlock = document.getElementById('sectionCompleteCorrectBlock');
        const sectionCorrectList = document.getElementById('sectionCompleteCorrectList');
        if (isSpellingWithWrong) {
          sectionCorrectBlock.classList.remove('hidden');
          sectionCorrectList.innerHTML = correctAnswersHtml;
        } else {
          sectionCorrectBlock.classList.add('hidden');
          sectionCorrectList.innerHTML = '';
        }
        document.getElementById('sectionCompleteScreen').classList.remove('hidden');
        document.getElementById('sectionCompleteNextBtn').textContent = coursePart === 1 ? 'Back to menu' : (part2Order.indexOf(coursePhase) < part2Order.length - 1 ? 'Next section' : 'Back to menu');
      } else {
        document.getElementById('resultScreen').classList.remove('hidden');
        document.getElementById('resultScore').textContent = `Score: ${score} / ${currentQuestions.length}`;
        document.getElementById('ruleSummary').textContent = summary;
        document.getElementById('retryWrongBtn').classList.toggle('hidden', wrongIndices.length === 0);
        document.getElementById('exportWrongBtn').classList.toggle('hidden', wrongIndices.length === 0);
        const wrongCorrectBlock = document.getElementById('wrongAnswersCorrectBlock');
        const wrongCorrectList = document.getElementById('wrongAnswersCorrectList');
        if (isSpellingWithWrong) {
          wrongCorrectBlock.classList.remove('hidden');
          wrongCorrectList.innerHTML = correctAnswersHtml;
        } else {
          wrongCorrectBlock.classList.add('hidden');
          wrongCorrectList.innerHTML = '';
        }
        const reviewBlock = document.getElementById('topicsToReviewBlock');
        const reviewList = document.getElementById('topicsToReviewList');
        if (quizMode === 'diagnostic' && wrongTopics.size > 0) {
          reviewBlock.classList.remove('hidden');
          reviewList.innerHTML = '';
          wrongTopics.forEach(topicId => {
            const t = topics.find(x => x.id === topicId);
            const title = t ? t.title : topicId;
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'secondary';
            btn.textContent = 'Revise: ' + title;
            btn.addEventListener('click', () => {
              if (t) currentTopic = t;
              quizMode = 'normal';
              applyTopic();
              renderMenu();
            });
            reviewList.appendChild(btn);
          });
        } else {
          reviewBlock.classList.add('hidden');
          reviewList.innerHTML = '';
        }
      }
    }

    function retryWrong() {
      const toRetry = wrongIndices.map(i => currentQuestions[i]);
      currentQuestions = toRetry;
      currentIndex = 0;
      score = 0;
      wrongIndices = [];
      isRetryRound = true;
      document.getElementById('resultScreen').classList.add('hidden');
      document.getElementById('quizScreen').classList.remove('hidden');
      document.getElementById('exitQuizBtn').textContent = 'Exit quiz';
      showQuestion();
    }

    function exportWrong() {
      const lines = [
        'Wrong answers – ' + currentSetTitle,
        'Generated: ' + new Date().toLocaleString(),
        '',
      ];
      wrongIndices.forEach(i => {
        const q = currentQuestions[i];
        const correct = q.type === 'mc' ? (q.options && q.options[q.correct_option]) : (q.answers && q.answers[0]);
        lines.push('---');
        lines.push('Q: ' + (q.question || q.prompt || '').replace(/\n/g, ' '));
        lines.push('Correct: ' + correct);
        lines.push('Explanation: ' + (q.explanation || ''));
        lines.push('');
      });
      const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'review_wrong_answers.txt';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    document.getElementById('startBtn').addEventListener('click', startQuiz);
    document.getElementById('startPart1Btn').addEventListener('click', startPart1);
    document.getElementById('startPart2Btn').addEventListener('click', startPart2);
    document.getElementById('startDiagnosticBtn').addEventListener('click', startDiagnostic);
    document.getElementById('startMixedPracticeBtn').addEventListener('click', startMixedPractice);
    document.getElementById('introNextBtn').addEventListener('click', () => {
      if (introSectionIndex < (courseCurriculum?.intro?.sections?.length || 1) - 1) {
        showIntroSection(introSectionIndex + 1);
      } else {
        document.getElementById('introScreen').classList.add('hidden');
        if (coursePart === 1) startCourseSection('check');
      }
    });
    document.getElementById('sectionCompleteNextBtn').addEventListener('click', advanceCourseToNext);
    document.getElementById('submitBtn').addEventListener('click', submitAnswer);
    document.getElementById('nextBtn').addEventListener('click', nextQuestion);
    document.getElementById('retryWrongBtn').addEventListener('click', retryWrong);
    document.getElementById('exportWrongBtn').addEventListener('click', exportWrong);
    document.getElementById('backToMenuBtn').addEventListener('click', renderMenu);
    document.getElementById('exitQuizBtn').addEventListener('click', renderMenu);
    document.getElementById('introExitBtn').addEventListener('click', renderMenu);
    document.getElementById('viewPrepositionsListBtn').addEventListener('click', () => showPrepositionsList('menu'));
    document.getElementById('viewPrepositionsListFromIntroBtn').addEventListener('click', () => showPrepositionsList('intro'));
    document.getElementById('prepositionsListBackBtn').addEventListener('click', hidePrepositionsList);
    document.getElementById('prepositionsListPrintBtn').addEventListener('click', () => window.print());
    document.getElementById('prepositionsListDownloadBtn').addEventListener('click', () => {
      if (!prepositionsListData) return;
      const text = prepositionsListAsText(prepositionsListData);
      const blob = new Blob([text], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'prepositions_list.txt';
      a.click();
      URL.revokeObjectURL(a.href);
    });
    document.getElementById('viewPhrasalVerbsDictionaryBtn').addEventListener('click', () => showPhrasalVerbsDictionary('menu'));
    document.getElementById('viewPhrasalVerbsFromIntroBtn').addEventListener('click', () => showPhrasalVerbsDictionary('intro'));
    document.getElementById('phrasalVerbsDictionaryBackBtn').addEventListener('click', hidePhrasalVerbsDictionary);
    document.getElementById('phrasalVerbsDictionaryPrintBtn').addEventListener('click', () => window.print());
    document.getElementById('openReferenceBtn').addEventListener('click', showReference);
    document.getElementById('referenceBackBtn').addEventListener('click', onReferenceBackClick);
    document.getElementById('referencePrintBtn').addEventListener('click', () => window.print());
    document.getElementById('referenceDownloadBtn').addEventListener('click', () => {
      if (referenceView === 'phrasal_verbs' && phrasalVerbsDictionaryData) {
        const text = phrasalVerbsDictionaryAsText(phrasalVerbsDictionaryData);
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'phrasal_verbs_dictionary.txt';
        a.click();
        URL.revokeObjectURL(a.href);
      } else if (referenceView === 'prepositions' && prepositionsListData) {
        const text = prepositionsListAsText(prepositionsListData);
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'prepositions_list.txt';
        a.click();
        URL.revokeObjectURL(a.href);
      } else if (dependentPrepositionsData && (referenceView === 'dependent_verbs' || referenceView === 'dependent_nouns' || referenceView === 'dependent_adjectives' || referenceView === 'compound_nouns')) {
        const section = referenceView === 'dependent_verbs' ? 'verbs' : referenceView === 'dependent_nouns' ? 'nouns' : referenceView === 'dependent_adjectives' ? 'adjectives' : 'compound_nouns';
        const text = dependentPrepositionsSectionAsText(dependentPrepositionsData, section);
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'dependent_prepositions_' + section + '.txt';
        a.click();
        URL.revokeObjectURL(a.href);
      } else if (referenceView === 'countable_uncountable' && countableUncountableData) {
        const text = countableUncountableAsText(countableUncountableData);
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'uncountable_always_plural.txt';
        a.click();
        URL.revokeObjectURL(a.href);
      } else if (referenceInfinitiveIngData) {
        const text = referenceAsText(referenceInfinitiveIngData);
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'infinitive_ing_verb_lists.txt';
        a.click();
        URL.revokeObjectURL(a.href);
      }
    });
    document.getElementById('phrasalVerbsDictionaryDownloadBtn').addEventListener('click', () => {
      if (!phrasalVerbsDictionaryData) return;
      const text = phrasalVerbsDictionaryAsText(phrasalVerbsDictionaryData);
      const blob = new Blob([text], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'phrasal_verbs_dictionary.txt';
      a.click();
      URL.revokeObjectURL(a.href);
    });
    document.getElementById('openInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); submitAnswer(); }
    });
    document.addEventListener('keydown', function(e) {
      if (e.key !== 'Enter') return;
      const quizScreen = document.getElementById('quizScreen');
      if (!quizScreen || quizScreen.classList.contains('hidden')) return;
      const fb = document.getElementById('feedbackBlock');
      if (fb && !fb.classList.contains('hidden')) return;
      const q = currentQuestions && currentQuestions[currentIndex];
      if (!q) return;
      if (q.type === 'mc' && selectedMc != null) { e.preventDefault(); submitAnswer(); }
    });

    const practiceWeakBtn = document.getElementById('practiceWeakBtn');
    if (practiceWeakBtn) {
      practiceWeakBtn.addEventListener('click', () => {
        const select = document.getElementById('setSelect');
        if (select && select.querySelector('option[value="weakspots"]')) {
          select.value = 'weakspots';
          startQuiz();
        }
      });
    }
    document.getElementById('setSelect').addEventListener('change', () => {
      const selVal = document.getElementById('setSelect').value;
      const summaryEl = document.getElementById('scoresSummary');
      if (selVal === 'weakspots') {
        const weakSpots = getWeakSpotQuestions();
        summaryEl.textContent = weakSpots.length + ' questions you\'ve got wrong before – practise them to improve.';
      } else {
        const lastBest = getLastBest(selVal);
        if (lastBest.last) {
          summaryEl.textContent = 'Last: ' + lastBest.last[0] + '/' + lastBest.last[1] +
            (lastBest.best && (lastBest.best[0] !== lastBest.last[0] || lastBest.best[1] !== lastBest.last[1]) ? '  •  Best: ' + lastBest.best[0] + '/' + lastBest.best[1] : '');
        } else summaryEl.textContent = '';
      }
    });
    document.getElementById('topicSelect').addEventListener('change', () => {
      const idx = parseInt(document.getElementById('topicSelect').value, 10);
      if (topics[idx] != null) {
        currentTopic = topics[idx];
        applyTopic();
        renderMenu();
      }
    });

    (async function init() {
      try {
        const mRes = await fetch(new URL('manifest.json?v=2', getBaseUrl()));
        if (mRes.ok) {
          const mData = await mRes.json();
          topics = mData.topics || [];
          if (topics.length > 0) {
            currentTopic = topics[0];
            document.getElementById('topicLabel').classList.remove('hidden');
            document.getElementById('topicSelect').classList.remove('hidden');
            const sel = document.getElementById('topicSelect');
            sel.innerHTML = '';
            topics.forEach((t, i) => {
              const opt = document.createElement('option');
              opt.value = i;
              opt.textContent = t.title || t.id;
              sel.appendChild(opt);
            });
          }
        }
        await loadQuestions();
        renderMenu();
      } catch (err) {
        topics = [
          { id: 'articles', title: 'Articles (a, an, the, ∅)', curriculum: 'curriculum_articles.json', questions_key: 'articles' },
          { id: 'comparatives', title: 'Comparatives and Superlatives', curriculum: 'curriculum_comparatives.json', questions_key: 'comparatives' },
          { id: 'conjunctions_linkers', title: 'Conjunctions and linkers', curriculum: 'curriculum_conjunctions_linkers.json', questions_key: 'conjunctions_linkers' },
          { id: 'countable_uncountable', title: 'Nouns: Countable and uncountable', curriculum: 'curriculum_countable_uncountable.json', questions_key: 'countable_uncountable' },
          { id: 'infinitive_ing', title: 'Infinitive and -ing form', curriculum: 'curriculum_infinitive_ing.json', questions_key: 'infinitive_ing' },
          { id: 'passives', title: 'Passives', curriculum: 'curriculum_passives.json', questions_key: 'passives' },
          { id: 'phrasal_verbs', title: 'Phrasal verbs', curriculum: 'curriculum_phrasal_verbs.json', questions_key: 'phrasal_verbs' },
          { id: 'prepositions', title: 'Prepositions', curriculum: 'curriculum_prepositions.json', questions_key: 'prepositions' },
          { id: 'punctuation', title: 'Punctuation and capitalisation', curriculum: 'curriculum_punctuation.json', questions_key: 'punctuation' },
          { id: 'relative_pronouns', title: 'Relative pronouns', curriculum: 'curriculum_relative_pronouns.json', questions_key: 'relative_pronouns' },
          { id: 'reported_speech', title: 'Reported speech', curriculum: 'curriculum_reported_speech.json', questions_key: 'reported_speech' },
          { id: 'spelling', title: 'Spelling', curriculum: 'curriculum_spelling.json', questions_key: 'spelling' },
          { id: 'word_order', title: 'Word order in sentences', curriculum: 'curriculum_word_order.json', questions_key: 'word_order' },
          { id: 'conditionals', title: 'Tenses: Conditionals (zero, first, second, third)', curriculum: 'curriculum_conditionals.json', questions_key: 'conditionals' },
          { id: 'past_perfect', title: 'Tenses: Past Perfect', curriculum: 'curriculum_past_perfect.json', questions_key: 'past_perfect' },
          { id: 'past_simple_continuous', title: 'Tenses: Past Simple and Past Continuous', curriculum: 'curriculum_past_simple_continuous.json', questions_key: 'past_simple_continuous' },
          { id: 'past_simple_present_perfect', title: 'Tenses: Past Simple vs Present Perfect', curriculum: 'curriculum_past_simple_present_perfect.json', questions_key: 'past_simple_present_perfect' },
          { id: 'present_perfect', title: 'Tenses: Present Perfect Simple vs Continuous', curriculum: 'curriculum.json', questions_key: 'sets' },
          { id: 'will_going_to', title: 'Tenses: Will and going to', curriculum: 'curriculum_will_going_to.json', questions_key: 'will_going_to' }
        ];
        currentTopic = topics[0];
        document.getElementById('topicLabel').classList.remove('hidden');
        document.getElementById('topicSelect').classList.remove('hidden');
        const sel = document.getElementById('topicSelect');
        sel.innerHTML = '';
        topics.forEach((t, i) => {
          const opt = document.createElement('option');
          opt.value = i;
          opt.textContent = t.title || t.id;
          sel.appendChild(opt);
        });
        document.getElementById('scoresSummary').textContent = 'Could not load manifest.json (e.g. opened as file). Topic list loaded from fallback. Run from a local server for best results.';
        await loadQuestions().catch(() => {});
        renderMenu();
      }
    })();
  </script>
</body>
</html>
